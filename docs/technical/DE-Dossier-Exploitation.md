# Dossier d'Exploitation (DE)
# Z√©ro Logement Vacant

**Version:** 1.1
**Date:** 26 f√©vrier 2026
**Auteur:** Lo√Øc Guillois
**Statut:** En vigueur

---

## Introduction

### Qu'est-ce qu'un dossier d'exploitation ?

Un dossier d'exploitation est un manuel qui explique comment **maintenir et surveiller** une application en fonctionnement. C'est le guide que l'on consulte quand quelque chose ne va pas, ou pour effectuer des op√©rations de routine.

**Analogie :** Si l'application √©tait une voiture, ce document serait le manuel d'entretien : comment v√©rifier les niveaux, que faire si un voyant s'allume, comment changer une roue.

### √Ä qui s'adresse ce document ?

- **L'√©quipe technique** : pour les proc√©dures quotidiennes et la r√©solution d'incidents
- **Les d√©veloppeurs** : pour comprendre l'environnement de production
- **Tout intervenant** : qui doit interagir avec l'application en production

### Objectif

Ce document vous permettra de :
- **Surveiller** l'application et d√©tecter les probl√®mes
- **Diagnostiquer** les incidents rapidement
- **R√©soudre** les probl√®mes courants
- **Maintenir** l'application en bon √©tat de fonctionnement

---

## 1. Comprendre l'infrastructure

### 1.1 O√π est h√©berg√©e l'application ?

L'application ZLV est h√©berg√©e sur **Clever Cloud**, une plateforme fran√ßaise de type "PaaS" (Platform as a Service).

**Qu'est-ce qu'un PaaS ?**

Un PaaS est un service cloud qui g√®re automatiquement l'infrastructure technique (serveurs, r√©seau, s√©curit√©) pour vous. Contrairement √† un serveur classique o√π vous devez tout configurer, un PaaS s'occupe de :
- D√©marrer et arr√™ter les serveurs
- Installer les mises √† jour de s√©curit√©
- G√©rer les certificats SSL (le "https")
- Sauvegarder automatiquement les donn√©es

**Avantages pour ZLV :**
- H√©bergement en France (conformit√© RGPD)
- Pas de maintenance serveur √† g√©rer
- D√©ploiement automatique depuis GitHub
- Mont√©e en charge automatique si besoin

### 1.2 Les environnements

ZLV dispose de deux environnements identiques :

| Environnement | URL | Utilisation |
|---------------|-----|-------------|
| **Production** | https://zerologementvacant.beta.gouv.fr | Utilis√© par les vrais utilisateurs |
| **Staging** | https://zerologementvacant-staging.incubateur.net | Tests avant mise en production |

**Staging** (ou pr√©-production) est une copie de la production o√π l'on teste les nouvelles fonctionnalit√©s avant de les mettre √† disposition des utilisateurs r√©els.

### 1.3 Les composants de l'application

L'application est constitu√©e de plusieurs "briques" qui travaillent ensemble :

```mermaid
flowchart TB
    subgraph Users["Utilisateurs"]
        User[fa:fa-user Utilisateur final]
    end

    subgraph Production["Environnement Production"]
        Frontend["<b>Frontend</b><br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>L'interface visible<br/>par les utilisateurs<br/>(boutons, formulaires)"]
        Backend["<b>Backend API</b><br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>Le cerveau de l'application<br/>traite les demandes et<br/>applique les r√®gles m√©tier"]
        Queue["<b>Queue Worker</b><br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>Traite les t√¢ches longues<br/>en arri√®re-plan<br/>(exports, imports)"]
    end

    subgraph AddOns["Services de donn√©es"]
        PostgreSQL[("PostgreSQL<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>Base de donn√©es<br/>stocke toutes les<br/>informations")]
        Redis[("Redis<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>M√©moire rapide<br/>pour les files<br/>d'attente")]
        Elasticsearch[("Elasticsearch<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>Recherche dans<br/>les logs")]
        Cellar[("Cellar S3<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>Stockage des<br/>fichiers")]
    end

    User --> Frontend
    Frontend --> Backend
    Backend --> PostgreSQL
    Backend --> Redis
    Backend --> Elasticsearch
    Backend --> Cellar
    Queue --> Redis
    Queue --> PostgreSQL
```

**Explication de chaque composant :**

| Composant | R√¥le | Analogie |
|-----------|------|----------|
| **Frontend** | Interface utilisateur (ce que l'on voit) | La vitrine du magasin |
| **Backend API** | Logique m√©tier (ce qui traite les donn√©es) | L'arri√®re-boutique |
| **Queue Worker** | T√¢ches en arri√®re-plan | L'employ√© qui range le stock |
| **PostgreSQL** | Base de donn√©es principale | Les classeurs d'archives |
| **Redis** | M√©moire temporaire et files d'attente | Le pense-b√™te sur le bureau |
| **Elasticsearch** | Moteur de recherche dans les logs | L'index des archives |
| **Cellar S3** | Stockage de fichiers | L'armoire √† documents |

### 1.4 Ressources allou√©es

Chaque composant dispose de ressources (puissance de calcul et m√©moire) :

| Composant | Taille | Description |
|-----------|--------|-------------|
| Frontend | S (Small) | 1 processeur, 512 MB m√©moire |
| Backend | M (Medium) | 2 processeurs, 2 GB m√©moire |
| Queue | S (Small) | 1 processeur, 512 MB m√©moire |

Ces tailles peuvent √™tre augment√©es en cas de forte charge (voir section Scaling).

---

## 2. Surveiller l'application

### 2.1 Qu'est-ce que la supervision ?

La supervision consiste √† **observer en permanence** l'application pour :
- D√©tecter les probl√®mes avant qu'ils n'impactent les utilisateurs
- Comprendre le comportement de l'application
- Anticiper les besoins en ressources

**Analogie :** C'est comme le tableau de bord d'une voiture qui affiche la vitesse, le niveau d'essence, la temp√©rature moteur.

### 2.2 Les outils de supervision

```mermaid
flowchart LR
    subgraph Application
        App["Application ZLV"]
    end

    subgraph Supervision["Outils de supervision"]
        Sentry["<b>Sentry</b><br/>D√©tecte les erreurs<br/>dans le code"]
        CleverLogs["<b>Clever Cloud</b><br/>Journaux en temps r√©el"]
        ES[("<b>Elasticsearch</b><br/>Historique des logs")]
        Kibana["<b>Kibana</b><br/>Tableaux de bord"]
    end

    subgraph Alertes["Notifications"]
        Slack["Slack"]
        Email["Email"]
    end

    App -->|Erreurs| Sentry
    App -->|Logs| CleverLogs
    CleverLogs --> ES
    ES --> Kibana
    Sentry -->|Alerte| Slack
    Sentry -->|Alerte| Email
```

**Sentry** : Outil qui d√©tecte automatiquement les erreurs dans le code et envoie des alertes. Quand un utilisateur rencontre un probl√®me, Sentry capture les d√©tails techniques.

**Logs** : Journal chronologique de tout ce qui se passe dans l'application. Chaque action (connexion, recherche, erreur) est enregistr√©e avec un horodatage.

**Kibana** : Interface graphique pour rechercher dans les logs et cr√©er des tableaux de bord.

### 2.3 V√©rifier que l'application fonctionne (Health Check)

Un "Health Check" (bilan de sant√©) est une v√©rification rapide que l'application r√©pond correctement.

**Comment faire :**

```bash
# Tester que l'API r√©pond
curl -s https://zerologementvacant.beta.gouv.fr/api | jq .

# R√©sultat attendu :
# { "status": "healthy" }
```

**Que signifient les r√©sultats ?**

| R√©ponse | Signification |
|---------|---------------|
| `{ "status": "healthy" }` | Tout va bien |
| Erreur 502/503 | L'application ne r√©pond pas |
| Timeout | L'application est trop lente |

**Via Clever Cloud :**

```bash
clever status    # √âtat global de l'application
```

### 2.4 Indicateurs cl√©s (KPIs)

Les KPIs (Key Performance Indicators) sont des m√©triques qui indiquent la "sant√©" de l'application :

| M√©trique | Cible | Seuil d'alerte | Explication |
|----------|-------|----------------|-------------|
| Temps de r√©ponse (p50) | < 200ms | > 500ms | La moiti√© des requ√™tes sont plus rapides |
| Temps de r√©ponse (p95) | < 1s | > 2s | 95% des requ√™tes sont plus rapides |
| Taux d'erreur | < 0.1% | > 1% | Pourcentage de requ√™tes en √©chec |
| Utilisation CPU | < 70% | > 90% | Charge du processeur |
| Utilisation m√©moire | < 80% | > 90% | M√©moire utilis√©e |

**p50 et p95** : Ce sont des "percentiles". p50 signifie que 50% des requ√™tes sont plus rapides que cette valeur. p95 donne une id√©e des cas les plus lents (seulement 5% sont plus lents).

### 2.5 Alertes automatiques

Les alertes sont configur√©es dans Sentry pour notifier l'√©quipe :

| Situation | S√©v√©rit√© | Action requise |
|-----------|----------|----------------|
| Plus de 10 erreurs/minute | P2 - Majeur | Investigation imm√©diate |
| Nouvelle erreur jamais vue | P3 - Moyen | Analyser sous 4 heures |
| Pic d'erreurs (3x le taux normal) | P2 - Majeur | Investigation sous 1 heure |

---

## 3. Proc√©dures d'exploitation

### 3.1 D√©ployer une nouvelle version

**Qu'est-ce qu'un d√©ploiement ?**

Un d√©ploiement consiste √† mettre √† jour l'application avec une nouvelle version du code. Sur Clever Cloud, c'est **automatique** : d√®s qu'un code est fusionn√© dans la branche "main" sur GitHub, la nouvelle version est d√©ploy√©e.

**Pr√©requis avant de d√©ployer :**

- [ ] Les tests automatiques passent (CI verte)
- [ ] Le code a √©t√© relu par un pair (Code Review)
- [ ] Pas d'incident en cours
- [ ] Les migrations de base de donn√©es ont √©t√© test√©es localement

**Suivre un d√©ploiement :**

```bash
# Voir l'historique des d√©ploiements
clever activity

# Suivre les logs en direct
clever logs -f

# V√©rifier que tout fonctionne apr√®s d√©ploiement
curl -s https://zerologementvacant.beta.gouv.fr/api | jq .
```

### 3.2 Revenir √† une version pr√©c√©dente (Rollback)

Si une nouvelle version pose probl√®me, on peut revenir √† la version pr√©c√©dente. C'est ce qu'on appelle un "rollback".

**Temps cible : moins de 5 minutes**

```bash
# 1. Identifier le dernier commit fonctionnel
git log --oneline -10

# 2. D√©ployer cette version
clever deploy --force <commit-sha-precedent>

# 3. V√©rifier que √ßa fonctionne
curl -s https://zerologementvacant.beta.gouv.fr/api | jq .
```

**Exemple concret :**
```bash
# Les 10 derniers d√©ploiements
git log --oneline -10
# a1b2c3d Ajout nouvelle fonctionnalit√© (bugu√©)
# x9y8z7w Correction du formulaire (fonctionnel)

# Revenir √† la version fonctionnelle
clever deploy --force x9y8z7w
```

### 3.3 Rollback avec migration de base de donn√©es

Si la mise √† jour incluait une modification de la base de donn√©es (migration), il faut aussi annuler cette modification :

```bash
# 1. Revenir √† l'ancienne version du code
clever deploy --force <commit-sha-precedent>

# 2. Annuler la derni√®re migration
DATABASE_URL=$POSTGRESQL_ADDON_URI yarn workspace @zerologementvacant/server migrate:rollback

# 3. V√©rifier l'√©tat des migrations
DATABASE_URL=$POSTGRESQL_ADDON_URI yarn workspace @zerologementvacant/server migrate:status
```

### 3.4 Red√©marrer l'application

Parfois, un simple red√©marrage r√©sout les probl√®mes :

```bash
# Red√©marrage normal
clever restart

# Red√©marrage complet (efface le cache de compilation)
clever restart --without-cache
```

**Quand red√©marrer ?**
- Application qui r√©pond lentement
- M√©moire satur√©e
- Apr√®s une modification de variable d'environnement

### 3.5 Augmenter les ressources (Scaling)

Si l'application est lente ou surcharg√©e, on peut augmenter ses ressources :

**Scaling vertical** (machine plus puissante) :
```bash
# Passer √† une instance plus grande
clever scale --flavor L

# Revenir √† la taille normale
clever scale --flavor M
```

**Scaling horizontal** (plus de machines) :
```bash
# Ajouter une deuxi√®me instance
clever scale --instances 2

# Revenir √† une instance
clever scale --instances 1
```

**Tailles disponibles :**

| Taille | CPU | M√©moire | Usage |
|--------|-----|---------|-------|
| S | 1 | 512 MB | D√©veloppement |
| M | 2 | 2 GB | Production normale |
| L | 4 | 4 GB | Forte charge |
| XL | 8 | 8 GB | Pics exceptionnels |

### 3.6 Fen√™tres de maintenance

Pour minimiser les risques, certaines p√©riodes sont pr√©f√©rables pour les interventions :

| Jour | Horaire (Paris) | Risque |
|------|-----------------|--------|
| Lundi-Jeudi | 10:00-16:00 | Faible |
| Vendredi | 10:00-14:00 | Moyen |
| Vendredi apr√®s-midi | **√Ä √©viter** | √âlev√© |
| Week-end | Urgences uniquement | √âlev√© |

**R√®gle d'or :** Ne pas d√©ployer le vendredi apr√®s-midi. Si un probl√®me survient, il sera difficile √† r√©soudre pendant le week-end.

---

## 4. Gestion des incidents

### 4.1 Qu'est-ce qu'un incident ?

Un incident est tout √©v√©nement qui emp√™che l'application de fonctionner normalement. Les incidents sont class√©s par s√©v√©rit√© :

| Niveau | Nom | D√©finition | D√©lai de r√©ponse | Exemples |
|--------|-----|------------|------------------|----------|
| **P1** | Critique | Service indisponible | 15 minutes | Application inaccessible |
| **P2** | Majeur | Fonctionnalit√© importante cass√©e | 1 heure | Impossible de se connecter |
| **P3** | Moyen | Fonctionnalit√© d√©grad√©e | 4 heures | Lenteurs, bugs mineurs |
| **P4** | Mineur | Probl√®me cosm√©tique | 24 heures | D√©faut d'affichage |

### 4.2 Proc√©dure de r√©ponse √† un incident

#### √âtape 1 : Triage initial (5 premi√®res minutes)

V√©rifier rapidement l'√©tat de l'application :

```bash
# L'API r√©pond-elle ?
curl -s https://zerologementvacant.beta.gouv.fr/api | jq .

# √âtat sur Clever Cloud
clever status

# D√©ploiements r√©cents (souvent la cause)
clever activity | head -10
```

#### √âtape 2 : √âvaluer l'impact

R√©pondre √† ces questions :
- [ ] Combien d'utilisateurs sont affect√©s ?
- [ ] Quelles fonctionnalit√©s sont cass√©es ?
- [ ] Y a-t-il un risque pour les donn√©es ?
- [ ] Quand le probl√®me a-t-il commenc√© ?

#### √âtape 3 : Communiquer

Informer l'√©quipe avec un message structur√© :

```
üî¥ INCIDENT P[X] - [Description br√®ve]
Impact: [Qui/quoi est affect√©]
Status: En investigation
Lead: [Votre nom]
Mises √† jour: Toutes les [15/30/60] min
```

#### √âtape 4 : R√©soudre

Consulter les proc√©dures sp√©cifiques ci-dessous selon le type d'incident.

#### √âtape 5 : Post-mortem (P1/P2 uniquement)

Apr√®s un incident majeur, documenter :
1. Chronologie des √©v√©nements
2. Impact (utilisateurs, donn√©es)
3. Cause racine
4. Actions correctives
5. Mesures de pr√©vention

### 4.3 Application inaccessible (P1)

**Sympt√¥mes :** Erreurs 502/503, timeouts, page blanche

**Diagnostic :**
```bash
# Consulter les derni√®res lignes de logs
clever logs --before "5 minutes ago"

# Voir les derniers d√©ploiements
clever activity | head -20
```

**R√©solution :**

```bash
# Option 1 : Red√©marrer simplement
clever restart

# Option 2 : Si manque de ressources
clever scale --flavor M

# Option 3 : Si le dernier d√©ploiement est en cause
clever deploy --force <commit-precedent>
```

### 4.4 Probl√®mes de base de donn√©es (P1)

**Sympt√¥mes :** "Connection refused", "too many connections"

**Diagnostic :**
```bash
# Nombre de connexions actives
psql $POSTGRESQL_ADDON_URI -c "SELECT count(*) FROM pg_stat_activity;"

# D√©tail par √©tat
psql $POSTGRESQL_ADDON_URI -c "SELECT state, count(*) FROM pg_stat_activity GROUP BY state;"
```

**R√©solution :**
```bash
# Fermer les connexions inactives depuis plus de 10 minutes
psql $POSTGRESQL_ADDON_URI -c "
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE state = 'idle'
AND query_start < now() - interval '10 minutes';
"

# Puis red√©marrer l'application
clever restart
```

### 4.5 √âchecs d'authentification (P2)

**Sympt√¥mes :** Impossible de se connecter, erreurs 401

**Diagnostic :**
```bash
# Chercher les erreurs li√©es √† l'authentification
clever logs | grep -i "auth\|jwt\|token"

# V√©rifier la variable de secret
clever env | grep AUTH_SECRET
```

**R√©solution :**
```bash
# Si le secret a √©t√© modifi√© par erreur
clever env set AUTH_SECRET="<secret-correct>"
clever restart
```

---

## 5. Sauvegarde et restauration

### 5.1 Qu'est-ce qu'une sauvegarde ?

Une sauvegarde (backup) est une copie des donn√©es √† un instant T. En cas de probl√®me (erreur humaine, bug, piratage), on peut restaurer les donn√©es depuis cette copie.

**Clever Cloud effectue des sauvegardes automatiques :**

| Composant | Fr√©quence | Conservation | Localisation |
|-----------|-----------|--------------|--------------|
| PostgreSQL | Quotidienne | 30 jours | Clever Cloud |
| Redis | Horaire | 7 jours | Clever Cloud |
| Fichiers (Cellar) | - | Permanent | Clever Cloud |
| Logs | Mensuelle | 1 an | Cellar S3 |

### 5.2 Sauvegarde manuelle

Pour cr√©er une sauvegarde manuelle (avant une op√©ration risqu√©e par exemple) :

```bash
# Sauvegarde compl√®te de la base
pg_dump $POSTGRESQL_ADDON_URI > backup_$(date +%Y%m%d_%H%M%S).sql

# Sauvegarde compress√©e (plus petit)
pg_dump $POSTGRESQL_ADDON_URI | gzip > backup_$(date +%Y%m%d).sql.gz

# Sauvegarde de tables sp√©cifiques seulement
pg_dump $POSTGRESQL_ADDON_URI -t housing -t owners > housing_owners_backup.sql
```

### 5.3 Restauration

**Depuis les sauvegardes automatiques Clever Cloud :**

1. Aller dans le dashboard Clever Cloud
2. S√©lectionner l'add-on PostgreSQL
3. Onglet "Backups"
4. Cliquer sur "Restore" sur le backup souhait√©

‚ö†Ô∏è **ATTENTION : La restauration remplace TOUTES les donn√©es actuelles !**

**Depuis un fichier de sauvegarde :**

```bash
# Depuis un fichier SQL
psql $POSTGRESQL_ADDON_URI < backup.sql

# Depuis un fichier compress√©
gunzip -c backup.sql.gz | psql $POSTGRESQL_ADDON_URI
```

---

## 6. T√¢ches planifi√©es (Cron)

### 6.1 Qu'est-ce qu'un cron ?

Un "cron" est une t√¢che programm√©e qui s'ex√©cute automatiquement √† intervalles r√©guliers. C'est comme un r√©veil qui d√©clenche une action √† heure fixe.

### 6.2 T√¢ches configur√©es

Les t√¢ches sont d√©finies dans `clevercloud/cron.json` :

| T√¢che | Fr√©quence | Description |
|-------|-----------|-------------|
| Synchronisation Cerema | Toutes les 30 min | Met √† jour les p√©rim√®tres depuis l'API Cerema |
| Export des logs | 1er du mois √† 3h | Archive les logs du mois pr√©c√©dent vers S3 |

### 6.3 V√©rifier l'ex√©cution des crons

```bash
# Voir les logs de la synchronisation Cerema
clever logs | grep cerema

# Ex√©cuter manuellement pour tester
clever ssh
/app/server/src/scripts/perimeters-portaildf/cerema-sync.sh
```

### 6.4 En cas d'√©chec d'un cron

1. **V√©rifier les logs** : `clever logs | grep <nom-du-script>`
2. **V√©rifier les variables d'environnement** n√©cessaires
3. **Tester manuellement** via SSH
4. **Si fichier d'√©tat corrompu** :
   ```bash
   rm -f server/src/scripts/perimeters-portaildf/01-cerema-scraper/api_*_state.json
   ```

---

## 7. Maintenance de la base de donn√©es

### 7.1 Se connecter √† la base de donn√©es

```bash
# En production
psql $POSTGRESQL_ADDON_URI

# En local
psql postgres://postgres:postgres@localhost:5432/zlv
```

### 7.2 Requ√™tes de diagnostic utiles

```sql
-- Combien de connexions actives ?
SELECT count(*) as total,
       count(*) FILTER (WHERE state = 'active') as actives,
       count(*) FILTER (WHERE state = 'idle') as inactives
FROM pg_stat_activity;

-- Quelle taille fait la base ?
SELECT pg_size_pretty(pg_database_size(current_database()));

-- Quelles sont les plus grosses tables ?
SELECT relname as table,
       pg_size_pretty(pg_total_relation_size(relid)) as taille
FROM pg_catalog.pg_statio_user_tables
ORDER BY pg_total_relation_size(relid) DESC
LIMIT 10;

-- Y a-t-il des requ√™tes lentes en cours ?
SELECT pid, now() - query_start AS duree, query
FROM pg_stat_activity
WHERE state = 'active'
AND now() - query_start > interval '5 seconds';
```

### 7.3 Migrations de base de donn√©es

Les "migrations" sont des scripts qui modifient la structure de la base de donn√©es (ajout de colonnes, de tables, etc.).

```bash
# Appliquer les migrations en attente
yarn workspace @zerologementvacant/server migrate

# Voir l'√©tat des migrations
yarn workspace @zerologementvacant/server migrate:status

# Annuler la derni√®re migration
yarn workspace @zerologementvacant/server migrate:rollback

# Cr√©er une nouvelle migration
yarn workspace @zerologementvacant/server migrate:make nom_migration
```

### 7.4 Maintenance PostgreSQL

PostgreSQL a besoin de maintenance r√©guli√®re pour rester performant :

```sql
-- Mettre √† jour les statistiques (am√©liore les performances des requ√™tes)
ANALYZE;

-- Nettoyer et optimiser une table sp√©cifique
VACUUM ANALYZE fast_housing;

-- Reconstruire les index (sans bloquer les lectures)
REINDEX TABLE CONCURRENTLY fast_housing;
```

### 7.5 Interrompre une requ√™te lente

Si une requ√™te prend trop de temps et bloque les autres :

```sql
-- Identifier les requ√™tes lentes
SELECT pid, now() - query_start AS duree, query
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY duree DESC;

-- Annuler proprement (la requ√™te peut s'arr√™ter d'elle-m√™me)
SELECT pg_cancel_backend(<pid>);

-- Forcer l'arr√™t (si pg_cancel ne fonctionne pas)
SELECT pg_terminate_backend(<pid>);
```

---

## 8. Gestion des logs

### 8.1 Qu'est-ce qu'un log ?

Un log (ou journal) est un enregistrement chronologique de tout ce qui se passe dans l'application. Chaque action g√©n√®re une ligne de log avec :
- La date et l'heure
- Le niveau d'importance (erreur, avertissement, info)
- Le message descriptif

**Exemple de log :**
```
2024-02-26T14:30:00 INFO  User 123 logged in
2024-02-26T14:30:05 ERROR Database connection failed: timeout
```

### 8.2 Architecture des logs

```mermaid
flowchart LR
    App["Application"] --> CC["Clever Cloud<br/>7 jours"]
    CC --> Drain["Log Drain"]
    Drain --> ES[("Elasticsearch<br/>30 jours")]
    ES --> Kibana["Kibana<br/>Recherche"]
    ES -->|1er du mois| S3[("Cellar S3<br/>1 an")]
```

**Explication du flux :**
1. L'application g√©n√®re des logs
2. Clever Cloud les conserve 7 jours
3. Un "drain" les envoie vers Elasticsearch
4. Elasticsearch permet de les rechercher pendant 30 jours
5. Chaque mois, ils sont archiv√©s vers S3 pour 1 an

### 8.3 Consulter les logs

**En temps r√©el :**
```bash
# Voir les logs qui arrivent
clever logs -f

# Voir les logs de la derni√®re heure
clever logs --before "1 hour ago"

# Filtrer les erreurs
clever logs | grep -i error
```

**Dans Kibana (recherche avanc√©e) :**

```
# Erreurs de la derni√®re heure
level:error AND @timestamp:[now-1h TO now]

# Logs d'un endpoint sp√©cifique
message:"/api/housing" AND level:error

# Logs d'un utilisateur particulier
userId:"<uuid>"
```

### 8.4 Niveaux de log

| Niveau | Signification | Exemple |
|--------|---------------|---------|
| `error` | Probl√®me n√©cessitant une action | Connexion DB √©chou√©e |
| `warn` | Situation anormale mais g√©r√©e | Retry r√©ussi apr√®s √©chec |
| `info` | Information sur le fonctionnement | Utilisateur connect√© |
| `debug` | D√©tails techniques (d√©veloppement) | Param√®tres de requ√™te |

### 8.5 Exporter les logs

Pour archiver manuellement les logs :

```bash
# Exporter le mois pr√©c√©dent
./server/src/scripts/logs/export-monthly-logs.sh

# Exporter un mois sp√©cifique
./server/src/scripts/logs/export-monthly-logs.sh 2024-12
```

---

## 9. Contacts et escalade

### 9.1 Qu'est-ce que l'escalade ?

L'escalade consiste √† faire appel √† un niveau sup√©rieur quand un probl√®me d√©passe vos comp√©tences ou votre niveau d'autorisation. C'est normal et recommand√©.

### 9.2 Matrice d'escalade

| Niveau | R√¥le | Responsabilit√© | Quand escalader |
|--------|------|----------------|-----------------|
| 1 | D√©veloppeur d'astreinte | Premi√®re r√©ponse, triage | Si incident P1/P2 |
| 2 | Tech Lead | D√©cisions majeures | Si non r√©solu apr√®s 30 min |
| 3 | Support Clever Cloud | Probl√®mes d'infrastructure | Si probl√®me plateforme |

### 9.3 Proc√©dure d'escalade

**Pour un incident P1 (Service down) :**
1. 0-15 min : D√©veloppeur d'astreinte
2. 15-30 min : Escalade vers Tech Lead
3. 30+ min : Support Clever Cloud si probl√®me infrastructure

**Pour un incident P2 (Fonctionnalit√© majeure KO) :**
1. 0-1h : D√©veloppeur d'astreinte
2. 1h+ : Escalade vers Tech Lead

### 9.4 Contacts

| R√¥le | Contact |
|------|---------|
| D√©veloppeur d'astreinte | Voir planning de rotation sur Slack |
| Tech Lead | Voir canal Slack de l'√©quipe |
| Support Clever Cloud | support@clever-cloud.com |
| Support Brevo | Via dashboard Brevo |

---

## 10. Aide-m√©moire

### 10.1 Commandes essentielles

```bash
# === V√âRIFICATION ===
clever status                           # √âtat de l'application
curl https://zerologementvacant.beta.gouv.fr/api  # Test rapide

# === LOGS ===
clever logs                             # Logs r√©cents
clever logs -f                          # Suivre en temps r√©el
clever logs | grep error                # Filtrer les erreurs

# === D√âPLOIEMENT ===
clever activity                         # Historique
clever deploy                           # D√©ployer branche courante
clever deploy --force <sha>             # D√©ployer commit sp√©cifique

# === RED√âMARRAGE ===
clever restart                          # Red√©marrage normal
clever restart --without-cache          # Red√©marrage complet

# === SCALING ===
clever scale --flavor M                 # Changer taille
clever scale --instances 2              # Ajouter instances

# === ENVIRONNEMENT ===
clever env                              # Lister variables
clever env set KEY=value                # D√©finir variable
clever env rm KEY                       # Supprimer variable

# === BASE DE DONN√âES ===
psql $POSTGRESQL_ADDON_URI              # Connexion DB
yarn workspace @zerologementvacant/server migrate        # Migrations
```

### 10.2 Requ√™tes SQL utiles

```sql
-- Nombre de connexions
SELECT count(*) FROM pg_stat_activity;

-- Taille de la base
SELECT pg_size_pretty(pg_database_size(current_database()));

-- Plus grosses tables
SELECT relname, pg_size_pretty(pg_total_relation_size(relid))
FROM pg_catalog.pg_statio_user_tables
ORDER BY pg_total_relation_size(relid) DESC
LIMIT 10;

-- Requ√™tes en cours > 5 secondes
SELECT pid, now() - query_start AS duree, query
FROM pg_stat_activity
WHERE state = 'active'
AND now() - query_start > interval '5 seconds';

-- √âtat des migrations
SELECT * FROM knex_migrations ORDER BY id DESC LIMIT 10;
```

### 10.3 Checklist d'astreinte

**D√©but de shift :**
- [ ] V√©rifier les alertes Sentry en cours
- [ ] Consulter les d√©ploiements r√©cents
- [ ] V√©rifier les incidents ouverts
- [ ] S'assurer d'avoir acc√®s √† tous les outils

**Pendant le shift :**
- [ ] R√©pondre aux alertes dans les d√©lais
- [ ] Documenter les actions prises
- [ ] Escalader si n√©cessaire
- [ ] Tenir l'√©quipe inform√©e

**Fin de shift :**
- [ ] Transmettre les incidents en cours
- [ ] Mettre √† jour les notes d'incident
- [ ] Logger toute maintenance effectu√©e

---

## 11. URLs et ressources

### 11.1 Environnements

| Environnement | URL | Usage |
|---------------|-----|-------|
| **Production** | https://zerologementvacant.beta.gouv.fr | Application live |
| **Staging** | https://zerologementvacant-staging.incubateur.net | Tests et d√©mo |
| **API Health** | https://zerologementvacant.beta.gouv.fr/api | V√©rification sant√© |

### 11.2 Outils de monitoring et support

| Outil | URL/Acc√®s | R√¥le |
|-------|-----------|------|
| **Sentry** | https://sentry.io (voir dashboard ZLV) | Suivi des erreurs en temps r√©el |
| **Clever Cloud Console** | https://console.clever-cloud.com | Gestion des applications et add-ons |
| **GitHub Actions** | https://github.com/MTES-MCT/zero-logement-vacant/actions | CI/CD et d√©ploiements |
| **Vaultwarden** | https://vaultwarden.incubateur.net/ | Gestionnaire de secrets partag√©s |

### 11.3 Documentation

| Document | Localisation |
|----------|--------------|
| **DAT** | `docs/technical/DAT-Dossier-Architecture-Technique.md` |
| **DI** | `docs/technical/DI-Dossier-Installation.md` |
| **CLAUDE.md** | Racine du projet - Guide de d√©veloppement |
| **API Swagger** | `http://localhost:3001/api-docs` (dev) |
| **Spec OpenAPI** | `http://localhost:3001/api-docs.json` |

### 11.4 Acc√®s SSH Clever Cloud

Pour se connecter aux instances en production :

```bash
# S'authentifier
clever login

# Lier l'application (si pas d√©j√† fait)
clever link <app-id>

# Se connecter en SSH
clever ssh
```

Une fois connect√©, vous √™tes dans `/app/` avec acc√®s au code d√©ploy√©.

---

## Glossaire

| Terme | D√©finition |
|-------|------------|
| **Add-on** | Service g√©r√© par Clever Cloud (base de donn√©es, Redis, etc.) |
| **Backup** | Copie de sauvegarde des donn√©es |
| **Cron** | T√¢che programm√©e qui s'ex√©cute automatiquement |
| **Drain** | Redirection des logs vers un syst√®me externe |
| **Flavor** | Taille d'une instance (S, M, L, XL) |
| **Health Check** | V√©rification automatique que l'application fonctionne |
| **KPI** | Indicateur cl√© de performance |
| **Log** | Journal chronologique des √©v√©nements de l'application |
| **Migration** | Script qui modifie la structure de la base de donn√©es |
| **PaaS** | Platform as a Service - h√©bergement g√©r√© |
| **Percentile** | Mesure statistique (p50 = m√©diane, p95 = 95% sont en dessous) |
| **Rollback** | Retour √† une version pr√©c√©dente |
| **Scaling** | Ajustement des ressources (vertical = plus puissant, horizontal = plus d'instances) |
| **Staging** | Environnement de test identique √† la production |

---

*Document mis √† jour le 26 f√©vrier 2026*
